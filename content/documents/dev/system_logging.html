+++
type = "article"
title = "System Logging"
date = "2003-12-14T05:00:00.000Z"
tags = ["syslog", "syslog_daemon", "POSIX"]
+++

<div class="field field-type-text field-field-body"><h3 class="field-label">Body</h3><div class="field-items"><div class="field-item"><p>          The system logging capabilities in BeOS are built on top of the syslog          interface as defined by the POSIX standard. In addition to the functionality          provided by that standard, it has some BeOS specific extensions.          </p>          <p>          The following article will give an overview about how this service works          internally in Haiku, and how it can be used in applications. The implementation          as done in Haiku might differ from the actual implementation in BeOS, but it          is fully binary compatible.          </p>                   <h3>The syslog_daemon</h3>           <p>          The syslog service is provided by a standard BApplication that runs as a server in          the background, the syslog_daemon.          </p>          <p>          After it has been started during the system&#39;s boot process, it will just sit          there and wait for messages. Every call to syslog() or log_thread/team() will          pass a message to the server containing information about what should be          written to the log and with what options. The message is not a BMessage, but          a plain data structure that can be created without any knowledge about BMessages.          That is needed, because the service is used by the kernel as well.          </p>          <p>          The server then just passes on that message to its internal handlers. It has          two built-in handlers. One of them just processes the message and dumps a formatted          text to the syslog file at <em>/var/log/syslog</em>. The other one creates          a standard BMessage out of the message and broadcasts it to all of its listeners.          However, how you can communicate with the syslog_daemon to get those messages will          be the topic of another newsletter article.          </p>          <p>          If the syslog file reaches a certain size (512 kB), it will be renamed to <em>syslog.old</em>,          and a new syslog file is created.          </p>           <h3>Using the system logger</h3>           <p>          As already mentioned, the system logging capabilities are accessible via the standard          POSIX functions. Therefore, the <em>syslog.h</em> header is placed in the <em>headers/posix</em>          directory, and the functions are implemented in <em>libroot.so</em>. That&#39;s already          different from standard BeOS where you need to link against <em>libbe.so</em> to access          that functionality. The <em>syslog.h</em> header can be found in the <em>headers/be/support</em>          directory on a standard BeOS system.          <br />          The implementation and header have been moved to simplify porting of POSIX-compliant          applications; however, that neither breaks binary nor source compatibility (as long as you          haven&#39;t used &quot;#include &lt;support/syslog.h&gt;&quot; for your native Be apps.)          </p>                   <h4>Logging sessions</h4>           <p>          The first call of a function that will connect to the syslog service will create a          syslog session. It&#39;s important to know that there is one session for each thread          that uses the service, as well as one extra session for all team-wide logging          functions.          </p>          <p>          The original POSIX API as well as part of the additional BeOS API          both use thread specific sessions.  When a session is started, it will inherit the options          defined for the team session. That means you can set logging options that every          thread in your application will respect (if you don&#39;t overwrite them locally).          But in order to define team wide options, you have to specifically use the BeOS-specific          team API.          </p>                   <h4>Team functions</h4>           <ul>                  <li>void openlog_team(const char *ident, int logopt, int facility)                          <p>                          Sets the team logging options for the other team functions and for                          inherited sessions.                          </p><ul>                                  <li><strong>ident</strong> is the identification string that prepends every message from your team.</li>                                  <li><strong>logopt</strong> allows you to set several logging options (see below).</li>                                  <li><strong>facility</strong> determines from what facility your message has been sent; for your                                          standard issues, this should just be LOG_USER.</li>                          </ul>                          <p>&nbsp;</p></li>                  <li>void closelog_team(void)                          <p>                          Closes the current session. This has currently no effect for the team logging functions.                          </p>                  </li><li>void log_team(int priority, const char *message, ...)                          <p>                          Sends a message of the specified priority to the syslog daemon.                          </p>                  </li><li>int setlogmask_team(int priorityMask)                          <p>                          Use the LOG_MASK() macro to build a mask of priorities to show. All                          messages of other priorities will be discarded. Example uses:                          </p>                          <table border="0"><tbody><tr><td width="50">&nbsp;</td>                                  <td colspan="2">setlogmask_team(LOG_MASK(LOG_WARNING));</td></tr>                                  <tr><td>&nbsp;</td><td width="50">&nbsp;</td>                                  <td><em>// all messages of priority LOG_WARNING will be shown</em></td></tr>                          </tbody></table>                          <table border="0"><tbody><tr><td width="50">&nbsp;</td>                                  <td colspan="2">setlogmask_team(LOG_MASK(LOG_ERR + 1) - 1);</td></tr>                                  <tr><td>&nbsp;</td><td width="50">&nbsp;</td>                                  <td><em>// all messages with a priority level higher than LOG_ERR will be shown</em></td></tr>                          </tbody></table>                          </li>          </ul>           <h4>Thread functions</h4>                   The POSIX API and the thread specific Be API behave exactly in the same way;          the *_thread() functions just clobber the global namespace :).          All calls except for the closelog() calls will start a new session          if there is none yet, and will inherit the current team logging options if they do.           <ul>                  <li>void openlog_thread(const char *ident, int logopt, int facility)<br />                          void openlog(const char *ident, int logopt, int facility)                          <p>                          Sets the log options for the current thread.                          </p>                  </li><li>void closelog_thread(void)<br />                          void closelog(void)                          <p>                          Closes the thread session, and frees all associated data. The next                          call to the syslog service will start a new session, and will inherit                          the team log options at that point again.                          </p>                  </li><li>void log_thread(int priority, const char *message, ...)<br />                          syslog(int priority, const char *message, ...)                          <p>                          Sends a message of the specified priority to the syslog daemon.                          </p>                  </li><li>int setlogmask_thread(int priorityMask)<br />                          setlogmask(int priorityMask)                          <p>                          Use the LOG_MASK() macro to build a mask of priorities to show. All                          messages of other priorities will be discarded.                          </p></li>          </ul>           <h4>Logging options for openlog()</h4>           These are the options that can be passed to openlog()/openlog_thread()/openlog_team().          Note, its effects might be depending on the syslog listener; for example, for a GUI          syslog viewer, <strong>LOG_PID</strong> might have no effect at all.           <ul>                  <li><strong>LOG_PID</strong><br />                          log the process (thread/team) ID with each message</li>                  <li><strong>LOG_CONS</strong><br />                          if the message cannot be delivered to the syslog daemon, it will be                          directly dumped to stderr.</li>                  <li><strong>LOG_PERROR</strong>                          the message will not only be sent to the syslog daemon, it will also                          be written to the application&#39;s stderr, not only if sending fails like                          <strong>LOG_CONS</strong>.</li>          </ul>           There are some more flags defined, but they have currently no effect (notably,          <strong>LOG_ODELAY</strong>, <strong>LOG_NDELAY</strong>, <strong>LOG_NOWAIT</strong> and <strong>LOG_SERIAL</strong>).           <h3>Playing with the Haiku implementation</h3>           <p>          The server is implemented in <em>current/src/servers/syslog_daemon</em>, naturally,          you have to build and start it, before it&#39;ll work - although you can also check          out the syslog functionality without a living server.          </p>          <p>          To test the syslog functionality, you can use the provided test program. You&#39;ll          find it in <em>current/src/tests/kernel/libroot/posix/SyslogTest.cpp</em>. Edit          it as you please, and you&#39;ll get a good idea of how it works.          </p>           <h3>Differences between the Haiku and the BeOS implementations</h3>           <p>          As already written some paragraphs above, the implemenation has been moved from          <em>libbe.so</em> to <em>libroot.so</em>. But since all applications are linked against          <em>libroot.so</em> anyway, this won&#39;t have any impact on binary compatibility.          </p>          <p>          The header file <em>syslog.h</em> has been moved to the <em>headers/posix</em> directory,          where all other POSIX headers reside. If you&#39;ve previously used the full path of          the old header (&quot;#include &lt;support/syslog.h&gt;&quot;), you might encounter          errors when trying to compile your old code. The issue has not been finally decided on,          but it probably won&#39;t change in the release version of our headers.          </p>          <p>          It has not been tested if the thread logging functions inherit their settings from          the team session on R5 or not, and if this mechanism works similarly if it&#39;s in place.          </p>          <p>          The only other known difference is that our syslog_daemon implements a way to broadcast          the messages to a listener application. But as I already said earlier, this will be the          topic of another newsletter article. Also note that the actual implementation of that          protocol has not been finalized yet and is probably subject to change; your shiny system          logger viewer might need to be updated before we reach R1.          </p>           <h3>References</h3>           <p>          There is a brief introduction to the BeOS system logger at          <a href="http://www.beatjapan.org/mirror/www.be.com/aboutbe/benewsletter/Issue61.html">http://www.beatjapan.org/mirror/www.be.com/aboutbe/benewsletter/Issue61.html   </a>.          You can also find a description of the standard POSIX syslog functions at          <a href="http://www.opengroup.org/onlinepubs/007904975/functions/closelog.html">http://www.opengroup.org/onlinepubs/007904975/functions/closelog.html  </a>.          </p><br class="clear" /><br class="giImageBlock-clear-both" /></div></div></div>